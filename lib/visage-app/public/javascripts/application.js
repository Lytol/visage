// Generated by CoffeeScript 1.6.3
(function() {
  var Dimension, DimensionCollectionView, DimensionView, FailureView, Graph, GraphCollection, GraphCollectionView, GraphView, Host, HostCollection, Metric, MetricCollection, Profile, ProfileView, SuccessView, Timeframe, TimeframeCollection, TimeframeCollectionView, TimeframeView;

  Dimension = Backbone.Model.extend({
    defaults: {
      checked: false,
      display: true
    }
  });

  Host = Dimension.extend({});

  Metric = Dimension.extend({});

  Graph = Backbone.Model.extend({
    url: function() {
      var finish, host, plugin, query, start, that;
      that = this;
      host = that.get('host');
      plugin = that.get('plugin');
      start = that.get('start');
      finish = that.get('finish');
      query = {};
      if (start) {
        query.start = start;
      }
      if (finish) {
        query.finish = finish;
      }
      query = Object.getLength(query) > 0 ? '?' + Object.toQueryString(query) : '';
      return "/data/" + host + "/" + plugin + query;
    },
    parse: function(response) {
      var data, host, obj, plugin, that;
      that = this;
      host = response.host || that.get('host');
      plugin = response.plugin || that.get('plugin');
      data = response;
      obj = {};
      obj.data = data;
      obj.series = [];
      Object.each(data[host][plugin], function(instance, instanceName) {
        return Object.each(instance, function(metric, metricName) {
          var finish, interval, set, start;
          start = metric.start;
          finish = metric.finish;
          interval = (finish - start) / metric.data.length;
          data = metric.data.map(function(value, index) {
            var x, y;
            x = (start + index * interval) * 1000;
            y = value;
            return [x, y];
          });
          set = {
            name: formatSeriesLabel([host, plugin, instanceName, metricName]),
            data: data,
            percentile95: metric.percentile_95
          };
          return obj.series.push(set);
        });
      });
      obj.series = obj.series.sort(function(a, b) {
        if (a.name < b.name) {
          return -1;
        }
        if (a.name > b.name) {
          return 1;
        }
        return 0;
      });
      return obj;
    }
  });

  Timeframe = Backbone.Model.extend({
    currentUnixTime: function() {
      var date;
      date = new Date;
      return parseInt(date.getTime() / 1000);
    },
    relativeUnixTimeTo: function(value) {
      var that;
      that = this;
      return that.currentUnixTime() - (Math.abs(value) * 3600);
    },
    roundedUnixTimeTo: function(value) {
      if (value < 0) {
        return new Date().decrement('month', Math.abs(value)).set('date', 1).clearTime().getTime() / 1000;
      }
      if (value > 0) {
        return new Date().increment('month', value).set('date', 1).clearTime().getTime() / 1000;
      }
      return new Date().set('date', 1).clearTime().getTime() / 1000;
    },
    toTimeAttributes: function() {
      var attrs, finish, start, that, unit;
      that = this;
      unit = that.get('unit');
      start = that.get('start');
      finish = that.get('finish');
      attrs = {};
      if (unit === 'hours') {
        if (start) {
          attrs.start = that.relativeUnixTimeTo(start);
        }
        if (finish) {
          attrs.finish = that.relativeUnixTimeTo(finish);
        }
      } else if (unit === 'months') {
        if (start) {
          attrs.start = that.relativeUnixTimeTo(start);
        }
        if (finish) {
          attrs.finish = that.relativeUnixTimeTo(finish);
        }
      }
      attrs.label = that.get('label');
      return attrs;
    }
  });

  Profile = Backbone.Model.extend({
    permalink: function() {
      return window.location.protocol + '//' + window.location.host + ("/profiles/" + this.id);
    },
    url: function(options) {
      var id;
      id = this.id;
      if (options && options.json === false) {
        if (id) {
          return "/profiles/" + id;
        } else {
          return '/profiles';
        }
      } else {
        if (id) {
          return "/profiles/" + id + ".json";
        } else {
          return '/profiles';
        }
      }
    },
    change: function(event) {
      if (!event.success && !event.error) {
        if (event.changes.graphs) {
          return this.dirty(true);
        }
      }
    },
    dirty: function(status) {
      if (status) {
        this.is_dirty = status;
      }
      return !!this.is_dirty;
    },
    isAnonymous: function() {
      return !!this.get('anonymous');
    },
    isNotAnonymous: function() {
      return !this.isAnonymous();
    },
    initialize: function() {
      var id;
      id = document.location.pathname.split('/')[2];
      if (id === 'new') {
        return this.set('graphs', []);
      } else {
        return this.set('id', id);
      }
    },
    sync: function(method, original_model, options) {
      var graphs, model, simplified_graphs;
      if (['create', 'update'].contains(method)) {
        model = Object.clone(original_model);
        graphs = JSON.parse(JSON.stringify(original_model.get('graphs')));
        if (graphs.length > 0) {
          simplified_graphs = graphs.map(function(attrs) {
            return Object.subset(attrs, ['host', 'plugin', 'start', 'finish']);
          });
          model.set('graphs', simplified_graphs);
        }
      } else {
        model = original_model;
      }
      return Backbone.sync.apply(this, [method, model, options]);
    }
  });

  HostCollection = Backbone.Collection.extend({
    url: '/data',
    model: Host,
    parse: function(response) {
      var attrs;
      return attrs = response.hosts.map(function(host) {
        return {
          id: host
        };
      });
    },
    filter: function(term) {
      return this.each(function(item) {
        var error, match;
        try {
          match = !!item.get('id').match(term);
        } catch (_error) {
          error = _error;
          if (error.type !== 'malformed_regexp') {
            throw error;
          }
        }
        return item.set('display', match);
      });
    },
    selected: function() {
      return this.models.filter(function(model) {
        return model.get('checked') === true;
      });
    }
  });

  MetricCollection = Backbone.Collection.extend({
    url: '/data/*',
    model: Metric,
    parse: function(response) {
      var attrs;
      attrs = response.metrics.map(function(metric) {
        return {
          id: metric
        };
      });
      return _.sortBy(attrs, function(attr) {
        return attr.id;
      });
    },
    filter: function(term) {
      return this.each(function(item) {
        var error, match;
        try {
          match = !!item.get('id').match(term);
        } catch (_error) {
          error = _error;
          if (error.type !== 'malformed_regexp') {
            throw error;
          }
        }
        return item.set('display', match);
      });
    },
    selected: function() {
      return this.models.filter(function(model) {
        return model.get('checked') === true;
      });
    }
  });

  GraphCollection = Backbone.Collection.extend({
    model: Graph
  });

  TimeframeCollection = Backbone.Collection.extend({
    model: Timeframe
  });

  DimensionView = Backbone.View.extend({
    tagName: 'li',
    className: 'row',
    render: function() {
      var checkbox, id, label, name, that;
      that = this;
      id = name = this.model.id;
      checkbox = new Element('input', {
        'type': 'checkbox',
        'id': id,
        'class': "" + name + " checkbox",
        'checked': this.model.get('checked'),
        'events': {
          'change': function(event) {
            return that.model.set('checked', !that.model.get('checked'));
          }
        }
      });
      label = new Element('label', {
        'for': id,
        'html': id,
        'class': "" + name + " label",
        'title': "" + name
      });
      $(this.el).grab(checkbox);
      $(this.el).grab(label);
      return $(this.el).addEvent('click', function(event) {
        if (event.target.tagName.toLowerCase() === 'li') {
          checkbox = event.target.getElement('input.checkbox');
          if (checkbox) {
            checkbox.checked = !checkbox.checked;
          }
          return that.model.set('checked', !that.model.get('checked'));
        }
      });
    }
  });

  DimensionCollectionView = Backbone.View.extend({
    tagName: 'ul',
    className: 'dimensioncollection',
    initialize: function() {
      var container, icon, paper, search, that;
      that = this;
      container = $(that.options.container);
      icon = new Element('div', {
        'class': 'clear',
        'events': {
          'click': function(event) {
            var input, list, term;
            term = '';
            input = event.target.getParent('div.dimension').getElement('input.search');
            input.set('value', term);
            that.collection.filter(term);
            list = that.render().el;
            container.grab(list);
            icon = event.target.getParent('div.dimension').getElement('div.clear');
            return icon.setStyle('display', 'none');
          }
        }
      });
      paper = Raphael(icon, 26, 26);
      paper.path("M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z").attr({
        fill: "#aaa",
        stroke: "none"
      });
      search = new Element('input', {
        'type': 'text',
        'class': 'search',
        'autocomplete': 'off',
        'events': {
          'keyup': function(event) {
            var input, list, term;
            input = event.target;
            term = input.value;
            that.collection.filter(term);
            list = that.render().el;
            container.grab(list);
            if (term.length > 0) {
              return icon.setStyle('display', 'inline');
            } else {
              return icon.setStyle('display', 'none');
            }
          }
        }
      });
      container.grab(search);
      return container.grab(icon);
    },
    render: function() {
      var message, number_of_results, selectAll, that;
      that = this;
      that.el.empty();
      that.collection.each(function(model) {
        var view;
        view = new DimensionView({
          model: model
        });
        if (model.get('display')) {
          return that.el.grab(view.render());
        }
      });
      number_of_results = that.el.getChildren().length;
      if (number_of_results === 0) {
        message = new Element('li', {
          'html': 'No matches',
          'class': 'row'
        });
        that.el.grab(message);
      } else {
        selectAll = new Element('li', {
          'html': '&uarr; toggle all',
          'class': 'row toggle',
          'events': {
            'click': function(event) {
              var checkboxes;
              checkboxes = that.el.getElements('input.checkbox');
              return checkboxes.each(function(element) {
                element.fireEvent('change');
                return element.setProperty('checked', !element.getProperty('checked'));
              });
            }
          }
        });
        that.el.grab(selectAll);
      }
      return that;
    }
  });

  ProfileView = Backbone.View.extend({
    tagName: 'form',
    className: 'profile',
    initialize: function() {
      var that;
      return that = this;
    }
  });

  Highcharts.setOptions({
    global: {
      useUTC: false
    }
  });

  GraphView = Backbone.View.extend({
    tagName: 'li',
    className: 'graph',
    title: function() {
      var host, plugin, that;
      that = this;
      plugin = that.model.get('plugin');
      host = that.model.get('host');
      if (that.options.title) {
        return that.options.title;
      } else {
        if (plugin.match(/^curl_json/)) {
          plugin = plugin.split('-')[1].replace(/(-|_)/, ' ');
        }
        return [plugin, 'on', host].join(' ');
      }
    },
    seriesMinMax: function() {
      var endpoints, max, min, series, that;
      that = this;
      series = that.model.get('series');
      endpoints = series.map(function(set) {
        var max, min, values;
        values = set.data.map(function(point) {
          return point[1];
        });
        min = values.min();
        max = values.max();
        return [min, max];
      });
      min = endpoints.map(function(min, max) {
        return min;
      }).min();
      max = endpoints.map(function(min, max) {
        return max;
      }).max();
      return [min, max];
    },
    render: function() {
      var destroy, destroyPaper, element, max, min, move, movePaper, series, that, title, _ref;
      that = this;
      element = that.el;
      series = that.model.get('series');
      title = that.title();
      _ref = that.seriesMinMax(), min = _ref[0], max = _ref[1];
      element.setStyle('height', 0);
      that.chart = new Highcharts.Chart({
        series: series,
        chart: {
          renderTo: element,
          type: 'line',
          marginRight: 0,
          marginBottom: 60,
          zoomType: 'xy',
          resetZoomButton: {
            theme: {
              fill: 'white',
              stroke: '#020508',
              r: 0,
              states: {
                hover: {
                  fill: '#020508',
                  style: {
                    color: 'white'
                  }
                }
              }
            }
          },
          width: 873,
          height: 350,
          plotBorderWidth: 1,
          plotBorderColor: '#020508',
          events: {}
        },
        title: {
          text: title,
          style: {
            'fontSize': '18px',
            'fontWeight': 'bold',
            'color': '#333333',
            'font-family': 'Bitstream Vera Sans, Helvetica Neue, sans-serif'
          }
        },
        colors: ['#1F78B4', '#33A02C', '#E31A1C', '#FF7F00', '#6A3D9A', '#A6CEE3', '#B2DF8A', '#FB9A99', '#FDBF6F', '#CAB2D6', '#FFFF99'],
        xAxis: {
          lineWidth: 0,
          minPadding: 0.012,
          maxPadding: 0.012,
          tickLength: 5,
          tickColor: "#020508",
          startOnTick: false,
          endOnTick: false,
          gridLineWidth: 0,
          tickPixelInterval: 150,
          labels: {
            style: {
              color: '#000'
            }
          },
          title: {
            text: null
          },
          type: 'datetime',
          dateTimeLabelFormats: {
            second: '%H:%M:%S',
            minute: '%H:%M',
            hour: '%H:%M',
            day: '%d/%m',
            week: '%d/%m',
            month: '%m/%Y',
            year: '%Y'
          }
        },
        yAxis: {
          lineWidth: 0,
          minPadding: 0.05,
          maxPadding: 0.05,
          tickWidth: 1,
          tickColor: '#020508',
          startOnTick: false,
          endOnTick: false,
          gridLineWidth: 0,
          title: {
            text: null
          },
          labels: {
            style: {
              color: '#000'
            },
            formatter: function() {
              return formatValue(this.value, {
                'precision': 1,
                'min': min,
                'max': max
              });
            }
          }
        },
        plotOptions: {
          series: {
            shadow: false,
            lineWidth: 1,
            marker: {
              enabled: false,
              states: {
                hover: {
                  enabled: true,
                  radius: 4
                }
              }
            },
            states: {
              hover: {
                enabled: true,
                lineWidth: 1
              }
            }
          }
        },
        tooltip: {
          animation: false,
          shadow: false,
          shared: true,
          useHTML: true,
          formatter: function() {
            var options, s;
            options = {
              'precision': 1,
              'min': min,
              'max': max,
              'base': 1024
            };
            s = '';
            s += '<small>';
            s += "<span style='font-weight: bold'>Time:</span> ";
            s += formatDate(this.points[0].key);
            s += '</small>';
            s += '<table>';
            this.points.each(function(point, index) {
              s += "<tr>";
              s += "<td style='color: " + point.series.color + "'>" + point.series.name + ": </td>";
              s += "<td style='text-align: left'>" + formatValue(point.y, options) + "</td>";
              return s += "</tr>";
            });
            return s += '</table>';
          }
        },
        legend: {
          layout: 'horizontal',
          align: 'center',
          verticalAlign: 'top',
          y: 320,
          borderWidth: 0,
          floating: true,
          itemStyle: {
            cursor: 'pointer',
            color: '#1a1a1a'
          },
          itemHoverStyle: {
            color: '#111'
          }
        },
        credits: {
          enabled: false
        }
      });
      destroy = new Element('div', {
        'class': 'action destroy',
        'styles': {
          opacity: 0
        },
        'events': {
          'click': function(event) {
            return that.el.fade('out').get('tween').chain(function() {
              return that.el.tween('height', '0').get('tween').chain(function() {
                that.chart.destroy();
                that.el.destroy();
                that.model.collection.remove(that.model);
                return that.model.destroy();
              });
            });
          }
        }
      });
      destroyPaper = Raphael(destroy, 26, 26);
      destroyPaper.path("M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z");
      move = new Element('div', {
        'class': 'action move',
        'styles': {
          opacity: 0,
          cursor: 'move'
        }
      });
      movePaper = Raphael(move, 26, 26);
      movePaper.path("M4.082,8.083v2.999h24.835V8.083H4.082zM4.082,24.306h22.835v-2.999H4.082V20.306zM4.082,17.694h22.835v-2.999H4.082V13.694z");
      element.grab(move, 'top');
      element.grab(destroy, 'top');
      element.tween('height', 376);
      element.addEvent('mouseenter', function() {
        return move.tween('opacity', 1);
      });
      element.addEvent('mouseleave', function() {
        return move.tween('opacity', 0);
      });
      element.addEvent('mouseenter', function() {
        return destroy.tween('opacity', 1);
      });
      element.addEvent('mouseleave', function() {
        return destroy.tween('opacity', 0);
      });
      return element;
    }
  });

  SuccessView = "<form id='share' class='share'>  <div class='row'>    Share this profile of graphs with others:  </div>  <div class='row permalink'>    <a href='{{model.permalink}}' target='_profile_{{model.id}}'>{{model.permalink}}</a>  </div>  <hr/>  <div class='row question'>    <input id='profile-anonymous' name='profile[anonymous]' class='checkbox' type='checkbox' {{#model.isNotAnonymous}}checked=true{{/model.isNotAnonymous}} value='false'>    <label for='profile-anonymous'>Name this profile</label>    <p>Naming a profile is helpful if you need to refer back to a collection of graphs.</p>    <p>If you don't name the profile, you can still access it via the link above.</p>  </div>  <hr class='named'/>  <div class='row text named'>    <label for='profile-name'>Profile name</label>    <input id='profile-name' name='profile[name]' class='text' type='text' value='{{model.name}}'>  </div>  <hr class='named'/>  <div class='row question named'>    <input id='profile-timeframe' timeframe='profile[timeframe]' class='checkbox' type='checkbox' checked='{{model.timeframe}}'>    <label for='profile-timeframe'>Timeframe</label>    <p>Lorem ipsum dolor sit amet</p>  </div>  <hr class='named'/>  <div class='row text named'>    <label for='profile-tags'>Tags<span class='tip'> (comma separated)</label>    <input id='profile-tags' tags='profile[tags]' class='text' type='text' value='{{model.tags}}'>  </div></form>";

  FailureView = "<div id='errors'>\n  {{#each model}}\n  <div class='error message'><strong>Error:</strong> {{this}}</div>\n  {{/each}}\n</div>";

  GraphCollectionView = Backbone.View.extend({
    tagName: 'div',
    className: 'graph',
    views: [],
    initialize: function() {
      var element, icon, paper, shareToggler, that;
      that = this;
      element = that.el;
      that.sortable = new Sortables(element, {
        handle: 'div.action.move',
        opacity: 0.3,
        clone: true,
        revert: {
          duration: 500,
          transition: 'back:out'
        }
      });
      shareToggler = $('share-toggler');
      icon = new Element('div', {
        "class": 'icon'
      });
      paper = Raphael(icon, 32, 32);
      paper.path("M16.45,18.085l-2.47,2.471c0.054,1.023-0.297,2.062-1.078,2.846c-1.465,1.459-3.837,1.459-5.302-0.002c-1.461-1.465-1.46-3.836-0.001-5.301c0.783-0.781,1.824-1.131,2.847-1.078l2.469-2.469c-2.463-1.057-5.425-0.586-7.438,1.426c-2.634,2.637-2.636,6.907,0,9.545c2.638,2.637,6.909,2.635,9.545,0l0.001,0.002C17.033,23.511,17.506,20.548,16.45,18.085zM14.552,12.915l2.467-2.469c-0.053-1.023,0.297-2.062,1.078-2.848C19.564,6.139,21.934,6.137,23.4,7.6c1.462,1.465,1.462,3.837,0,5.301c-0.783,0.783-1.822,1.132-2.846,1.079l-2.469,2.468c2.463,1.057,5.424,0.584,7.438-1.424c2.634-2.639,2.633-6.91,0-9.546c-2.639-2.636-6.91-2.637-9.545-0.001C13.967,7.489,13.495,10.451,14.552,12.915zM18.152,10.727l-7.424,7.426c-0.585,0.584-0.587,1.535,0,2.121c0.585,0.584,1.536,0.584,2.121-0.002l7.425-7.424c0.584-0.586,0.584-1.535,0-2.121C19.687,10.141,18.736,10.142,18.152,10.727z");
      shareToggler.grab(icon, 'top');
      return shareToggler.addEvent('click', (function() {
        var current, profile;
        current = Backbone.history.fragment.toString();
        profile = window.profile;
        switch (false) {
          case !profile.isNew():
            profile.set({
              anonymous: true,
              timeframe: true
            });
            return profile.save({}, {
              success: (function(profile, response, options) {
                window.Application.navigate("profiles/" + profile.id, {
                  trigger: true
                });
                return this.displayShareModal();
              }).bind(this),
              error: (function(model, xhr, options) {
                var errors, response;
                response = JSON.parse(xhr.responseText);
                errors = [];
                Object.each(response.errors, (function(item, key, object) {
                  return item.each(function(message) {
                    return errors.include("" + (key.capitalize()) + " " + message);
                  });
                }));
                return this.displayShareModal({
                  template: 'failure',
                  model: errors
                });
              }).bind(this)
            });
          case !(profile.dirty() && profile.isAnonymous()):
            window.profile = profile = profile.clone();
            profile.unset('id');
            return profile.save({}, {
              success: (function(profile, response, options) {
                window.Application.navigate("profiles/" + profile.id, {
                  trigger: true
                });
                return this.displayShareModal();
              }).bind(this),
              error: (function(model, xhr, options) {
                return console.log(model, xhr, options);
              }).bind(this)
            });
          case !(profile.dirty() && profile.isNotAnonymous()):
            return profile.save({}, {
              success: (function(profile, response, options) {
                return this.displayShareModal();
              }).bind(this),
              error: (function(model, xhr, options) {
                return console.log(model, xhr, options);
              }).bind(this)
            });
          default:
            return this.displayShareModal();
        }
      }).bind(this));
    },
    render: function() {
      var that;
      that = this;
      that.collection.each(function(model) {
        var graph, view;
        if (!model.get('rendered')) {
          view = new GraphView({
            model: model
          });
          that.views.include(view);
          graph = view.render();
          that.el.grab(graph);
          model.set('rendered', true);
          return that.sortable.addItems(view.el);
        }
      });
      return that;
    },
    displayShareModal: function(options) {
      var context, html, modal, source, template;
      if (options == null) {
        options = {};
      }
      options.template || (options.template = 'success');
      options.model || (options.model = window.profile);
      modal = new LightFace({
        width: 600,
        draggable: true,
        title: 'Share profile',
        content: "<img src='/images/loader.gif'/>",
        buttons: [
          {
            title: 'Delete',
            color: 'red',
            event: function() {
              var destroy;
              destroy = confirm('Are you sure you want to delete this profile?');
              if (destroy) {
                return window.profile.destroy({
                  success: function(model, response) {
                    return window.location = '/profiles';
                  }
                });
              }
            }
          }, {
            title: "Close",
            color: 'blue',
            event: function() {
              return this.close();
            }
          }, {
            title: 'Save',
            color: 'green',
            event: function() {
              var form;
              form = this.messageBox.getElementById('share');
              form.set('send', {
                url: window.profile.url({
                  json: false
                }),
                onSuccess: (function(responseText, responseXML) {
                  return this.close();
                }).bind(this)
              });
              return form.send();
            }
          }
        ],
        resetOnScroll: true
      });
      ['delete', 'save', 'close'].each(function(title) {
        modal.showButton(title.capitalize()).set('id', "share-" + title);
        modal.showButton(title.capitalize()).set('class', 'action');
        return modal.showButton(title.capitalize()).getParent().set('id', "share-" + title + "-label");
      });
      modal.open();
      source = eval(options.template.capitalize() + 'View');
      template = Handlebars.compile(source);
      context = {
        model: options.model
      };
      html = template(context);
      modal.messageBox.set('html', html);
      switch (options.template) {
        case 'success':
          if (window.profile.get('anonymous')) {
            modal.messageBox.getElements('.named').each(function(element) {
              return element.hide();
            });
          }
          return modal.messageBox.getElementById('profile-anonymous').addEvent('click', function(event) {
            return modal.messageBox.getElements('.named').each(function(element) {
              return element.toggle();
            });
          });
        case 'failure':
          return ['delete', 'save'].each(function(title) {
            return modal.showButton(title.capitalize()).getParent().dispose();
          });
      }
    }
  });

  TimeframeView = Backbone.View.extend({
    tagName: 'li',
    className: 'timeframe',
    selected: false,
    render: function() {
      var that;
      that = this;
      that.el.set('html', this.model.get('label'));
      if (that.model.get('selected')) {
        that.el.addClass('selected');
      }
      that.el.addEvent('click', function() {
        var attrs, label;
        label = $('timeframe-label');
        label.set('html', that.model.get('label'));
        $('timeframes').fade('out');
        that.el.getParent('ul').getElements('li').each(function(el) {
          return el.removeClass('selected');
        });
        that.el.toggleClass('selected');
        attrs = that.model.toTimeAttributes();
        Cookie.write('timeframe', JSON.encode(attrs));
        return window.graphs.models.each(function(graph) {
          graph.set(attrs);
          return graph.fetch({
            success: function(model, response) {
              return window.graphsView.views.each(function(view) {
                view.model.get('series').each(function(series, index) {
                  return view.chart.series[index].setData(series.data, false);
                });
                return view.chart.redraw();
              });
            }
          });
        });
      });
      return that;
    }
  });

  TimeframeCollectionView = Backbone.View.extend({
    tagName: 'ul',
    className: 'timeframe',
    initialize: function() {
      var icon, label, paper, that, timeframe, toggler;
      that = this;
      icon = new Element('div', {
        "class": 'icon'
      });
      paper = Raphael(icon, 32, 32);
      paper.path("M10.666,18.292c0.275,0.479,0.889,0.644,1.365,0.367l3.305-1.677C15.39,16.99,15.444,17,15.501,17c0.828,0,1.5-0.671,1.5-1.5l-0.5-7.876c0-0.552-0.448-1-1-1c-0.552,0-1,0.448-1,1l-0.466,7.343l-3.004,1.96C10.553,17.204,10.389,17.816,10.666,18.292zM12.062,9.545c0.479-0.276,0.642-0.888,0.366-1.366c-0.276-0.478-0.888-0.642-1.366-0.366s-0.642,0.888-0.366,1.366C10.973,9.658,11.584,9.822,12.062,9.545zM8.179,18.572c-0.478,0.277-0.642,0.889-0.365,1.367c0.275,0.479,0.889,0.641,1.365,0.365c0.479-0.275,0.643-0.888,0.367-1.367C9.27,18.461,8.658,18.297,8.179,18.572zM9.18,10.696c-0.479-0.276-1.09-0.112-1.366,0.366s-0.111,1.09,0.365,1.366c0.479,0.276,1.09,0.113,1.367-0.366C9.821,11.584,9.657,10.973,9.18,10.696zM6.624,15.5c0,0.553,0.449,1,1,1c0.552,0,1-0.447,1.001-1c-0.001-0.552-0.448-0.999-1.001-1C7.071,14.5,6.624,14.948,6.624,15.5zM14.501,23.377c0,0.553,0.448,1,1,1c0.552,0,1-0.447,1-1s-0.448-1-1-1C14.949,22.377,14.501,22.824,14.501,23.377zM10.696,21.822c-0.275,0.479-0.111,1.09,0.366,1.365c0.478,0.276,1.091,0.11,1.365-0.365c0.277-0.479,0.113-1.09-0.365-1.367C11.584,21.18,10.973,21.344,10.696,21.822zM21.822,10.696c-0.479,0.278-0.643,0.89-0.366,1.367s0.888,0.642,1.366,0.365c0.478-0.275,0.643-0.888,0.365-1.366C22.913,10.584,22.298,10.42,21.822,10.696zM21.456,18.938c-0.274,0.479-0.112,1.092,0.367,1.367c0.477,0.274,1.089,0.112,1.364-0.365c0.276-0.479,0.112-1.092-0.364-1.367C22.343,18.297,21.73,18.461,21.456,18.938zM24.378,15.5c0-0.551-0.448-1-1-1c-0.554,0.002-1.001,0.45-1.001,1c0.001,0.552,0.448,1,1.001,1C23.93,16.5,24.378,16.053,24.378,15.5zM18.573,22.822c0.274,0.477,0.888,0.643,1.366,0.365c0.478-0.275,0.642-0.89,0.365-1.365c-0.277-0.479-0.888-0.643-1.365-0.367C18.46,21.732,18.296,22.344,18.573,22.822zM18.939,9.546c0.477,0.276,1.088,0.112,1.365-0.366c0.276-0.478,0.113-1.091-0.367-1.367c-0.477-0.276-1.09-0.111-1.364,0.366C18.298,8.659,18.462,9.27,18.939,9.546zM28.703,14.364C28.074,7.072,21.654,1.67,14.364,2.295c-3.254,0.281-6.118,1.726-8.25,3.877L4.341,4.681l-1.309,7.364l7.031-2.548L8.427,8.12c1.627-1.567,3.767-2.621,6.194-2.833c5.64-0.477,10.595,3.694,11.089,9.335c0.477,5.64-3.693,10.595-9.333,11.09c-5.643,0.476-10.599-3.694-11.092-9.333c-0.102-1.204,0.019-2.373,0.31-3.478l-3.27,1.186c-0.089,0.832-0.106,1.684-0.031,2.55c0.629,7.29,7.048,12.691,14.341,12.066C23.926,28.074,29.328,21.655,28.703,14.364z");
      toggler = $('timeframe-toggler');
      toggler.grab(icon, 'top');
      toggler.addEvent('click', function() {
        return that.el.fade('toggle');
      });
      timeframe = JSON.decode(Cookie.read('timeframe'));
      if (timeframe && timeframe.label) {
        label = $('timeframe-label');
        return label.set('html', timeframe.label);
      }
    },
    default_timeframe: function() {
      var that;
      that = this;
      return that.collection.find(function(model) {
        return model.get('default');
      });
    },
    render: function() {
      var that, timeframe;
      timeframe = JSON.decode(Cookie.read('timeframe'));
      that = this;
      that.el.empty();
      return that.collection.each(function(model) {
        var label, view;
        if (model === that.default_timeframe()) {
          model.set('selected', true);
          label = $('timeframe-label');
          label.set('html', model.label);
        }
        if (timeframe && timeframe.label === model.get('label') && !that.default_timeframe()) {
          model.set('selected', true);
        }
        view = new TimeframeView({
          model: model
        });
        return that.el.grab(view.render().el);
      });
    }
  });

  window.addEvent('domready', function() {
    var Workspace, button, hosts, hostsContainer, hostsView, metrics, metricsContainer, metricsView, timeframes, timeframesView;
    Workspace = Backbone.Router.extend({
      routes: {
        'profile/new': 'profile',
        'profile/:id': 'profile'
      }
    });
    window.Application = new Workspace();
    Backbone.history.start({
      pushState: true
    });
    hostsContainer = $('hosts');
    hosts = new HostCollection;
    hostsView = new DimensionCollectionView({
      collection: hosts,
      container: hostsContainer
    });
    hosts.fetch({
      success: function(collection) {
        var list;
        list = hostsView.render().el;
        return hostsContainer.grab(list);
      }
    });
    metricsContainer = $('metrics');
    metrics = new MetricCollection;
    metricsView = new DimensionCollectionView({
      collection: metrics,
      container: metricsContainer
    });
    metrics.fetch({
      success: function(collection) {
        var list;
        list = metricsView.render().el;
        return metricsContainer.grab(list);
      }
    });
    window.graphsContainer = $('graphs');
    window.graphs = new GraphCollection;
    window.graphsView = new GraphCollectionView({
      el: window.graphsContainer,
      collection: window.graphs
    });
    window.profile = new Profile();
    if (!window.profile.isNew()) {
      window.profile.fetch({
        success: function(model) {
          return model.get('graphs').each(function(attributes) {
            var graph;
            graph = new Graph(attributes);
            return graph.fetch({
              success: function(model, response) {
                window.graphs.add(graph);
                return window.graphsView.render().el;
              }
            });
          });
        }
      });
    }
    button = new Element('input', {
      'type': 'button',
      'value': 'Add graphs',
      'class': 'button',
      'styles': {
        'font-size': '80%',
        'padding': '4px 8px'
      },
      'events': {
        'click': function(event) {
          var selected_hosts, selected_metrics;
          selected_hosts = hosts.selected().map(function(host) {
            return host.get('id');
          }).unique();
          selected_metrics = metrics.selected().map(function(metric) {
            return metric.get('id').split('/')[0];
          }).unique();
          return selected_hosts.each(function(host) {
            var builder;
            selected_metrics.each(function(metric) {
              var attributes, graph, timeframe;
              attributes = {
                host: host,
                plugin: metric
              };
              timeframe = JSON.decode(Cookie.read('timeframe'));
              attributes = Object.merge(attributes, timeframe);
              graph = new Graph(attributes);
              return graph.fetch({
                success: function(model, response, options) {
                  var graphs;
                  graphs = JSON.parse(JSON.stringify(window.profile.get('graphs')));
                  graphs.push(graph.attributes);
                  window.profile.set('graphs', graphs);
                  window.graphs.add(graph);
                  return window.graphsView.render().el;
                },
                error: function(model, response, options) {
                  return console.log('error', model, response, options);
                }
              });
            });
            builder = $('builder');
            return builder.tween('padding-top', 24).get('tween').chain(function() {
              return builder.setStyle('border-top', '1px dotted #aaa');
            });
          });
        }
      }
    });
    $('display').grab(button);
    timeframes = new TimeframeCollection;
    timeframes.add([
      {
        label: 'last 1 hour',
        start: -1,
        unit: 'hours'
      }, {
        label: 'last 2 hours',
        start: -2,
        unit: 'hours'
      }, {
        label: 'last 6 hours',
        start: -6,
        unit: 'hours'
      }, {
        label: 'last 12 hours',
        start: -12,
        unit: 'hours'
      }, {
        label: 'last 24 hours',
        start: -24,
        unit: 'hours'
      }, {
        label: 'last 3 days',
        start: -72,
        unit: 'hours'
      }, {
        label: 'last 7 days',
        start: -168,
        unit: 'hours'
      }, {
        label: 'last 2 weeks',
        start: -336,
        unit: 'hours'
      }, {
        label: 'last 1 month',
        start: -774,
        unit: 'hours'
      }, {
        label: 'last 3 months',
        start: -2322,
        unit: 'hours'
      }, {
        label: 'last 6 months',
        start: -4368,
        unit: 'hours'
      }, {
        label: 'last 1 year',
        start: -8760,
        unit: 'hours'
      }, {
        label: 'last 2 years',
        start: -17520,
        unit: 'hours'
      }, {
        label: 'current month',
        start: 0,
        finish: 1,
        unit: 'months'
      }, {
        label: 'previous month',
        start: -1,
        finish: 0,
        unit: 'months'
      }, {
        label: 'two months ago',
        start: -2,
        finish: -1,
        unit: 'months'
      }, {
        label: 'three months ago',
        start: -3,
        finish: -2,
        unit: 'months'
      }
    ]);
    if (window.profile) {
      timeframes.add({
        label: 'As specified by profile',
        "default": true
      }, {
        at: 0
      });
    }
    timeframesView = new TimeframeCollectionView({
      collection: timeframes,
      el: $('timeframes')
    });
    return timeframesView.render();
  });

}).call(this);
